C:\Git_Repos\mana_meeples_singles_market>pnpm --filter ./apps/api test

> @mana-meeples/api@ test C:\Git_Repos\mana_meeples_singles_market\apps\api
> vitest


 DEV  v2.1.9 C:/Git_Repos/mana_meeples_singles_market/apps/api

stdout | tests/integration/auth.routes.test.ts
📝 Test logging initialized:
   JSON: C:\Git_Repos\mana_meeples_singles_market\apps\api\test-logs\test-env-1761157694574.json
   TXT:  C:\Git_Repos\mana_meeples_singles_market\apps\api\test-logs\test-env-1761157694574.txt

stdout | tests/integration/error-handling.test.ts
📝 Test logging initialized:
   JSON: C:\Git_Repos\mana_meeples_singles_market\apps\api\test-logs\test-env-1761157694573.json
   TXT:  C:\Git_Repos\mana_meeples_singles_market\apps\api\test-logs\test-env-1761157694573.txt

stdout | tests/integration/cards.search.test.ts
📝 Test logging initialized:
   JSON: C:\Git_Repos\mana_meeples_singles_market\apps\api\test-logs\test-env-1761157694560.json
   TXT:  C:\Git_Repos\mana_meeples_singles_market\apps\api\test-logs\test-env-1761157694560.txt

stdout | tests/integration/inventory.routes.test.ts
📝 Test logging initialized:
   JSON: C:\Git_Repos\mana_meeples_singles_market\apps\api\test-logs\test-env-1761157694576.json
   TXT:  C:\Git_Repos\mana_meeples_singles_market\apps\api\test-logs\test-env-1761157694576.txt

stdout | tests/e2e/checkout.flow.test.ts
📝 Test logging initialized:
   JSON: C:\Git_Repos\mana_meeples_singles_market\apps\api\test-logs\test-env-1761157694576.json
   TXT:  C:\Git_Repos\mana_meeples_singles_market\apps\api\test-logs\test-env-1761157694576.txt

stdout | tests/integration/storefront.routes.test.ts
📝 Test logging initialized:
   JSON: C:\Git_Repos\mana_meeples_singles_market\apps\api\test-logs\test-env-1761157694561.json
   TXT:  C:\Git_Repos\mana_meeples_singles_market\apps\api\test-logs\test-env-1761157694561.txt

stdout | tests/integration/orders.routes.test.ts
📝 Test logging initialized:
   JSON: C:\Git_Repos\mana_meeples_singles_market\apps\api\test-logs\test-env-1761157694560.json
   TXT:  C:\Git_Repos\mana_meeples_singles_market\apps\api\test-logs\test-env-1761157694560.txt

stdout | tests/integration/storefront.routes.test.ts
[dotenv@17.2.3] injecting env (22) from .env -- tip: 👥 sync secrets across teammates & machines: https://dotenvx.com/ops

stdout | tests/integration/inventory.routes.test.ts
[dotenv@17.2.3] injecting env (22) from .env -- tip: ⚙️  override existing env vars with { override: true }

stdout | tests/e2e/checkout.flow.test.ts
[dotenv@17.2.3] injecting env (22) from .env -- tip: 🔐 prevent building .env in docker: https://dotenvx.com/prebuild

stdout | tests/integration/inventory.routes.test.ts
🔐 AUTH POST /api/auth/admin/login - 2025-10-22T18:28:22.758Z
🔑 Admin login attempt - handler entered
📋 Credentials received: { username: 'admin', hasPassword: true }
🔍 Validating credentials...
✅ Credentials valid, generating token...
🎫 Token generated
🍪 Setting cookie with config: {
  httpOnly: true,
  secure: false,
  sameSite: 'strict',
  domain: '(current domain)'
}
📤 Sending response: { success: true, message: 'Login successful', expiresIn: '24h' }
✅ Response sent successfully

stdout | tests/integration/orders.routes.test.ts
[dotenv@17.2.3] injecting env (22) from .env -- tip: 🔐 encrypt with Dotenvx: https://dotenvx.com

stdout | tests/integration/orders.routes.test.ts
🔐 AUTH POST /api/auth/admin/login - 2025-10-22T18:28:22.945Z
🔑 Admin login attempt - handler entered
📋 Credentials received: { username: 'admin', hasPassword: true }
🔍 Validating credentials...
✅ Credentials valid, generating token...
🎫 Token generated
🍪 Setting cookie with config: {
  httpOnly: true,
  secure: false,
  sameSite: 'strict',
  domain: '(current domain)'
}
📤 Sending response: { success: true, message: 'Login successful', expiresIn: '24h' }
✅ Response sent successfully

stdout | tests/integration/cards.search.test.ts
[dotenv@17.2.3] injecting env (22) from .env -- tip: ⚙️  specify custom .env file path with { path: '/custom/path/.env' }

stdout | tests/integration/error-handling.test.ts
[dotenv@17.2.3] injecting env (22) from .env -- tip: 🔐 prevent building .env in docker: https://dotenvx.com/prebuild

stderr | tests/integration/cards.search.test.ts
⚠️ Unexpected database pool error: terminating connection due to administrator command

stdout | tests/integration/error-handling.test.ts > Error Handling > 400 Bad Request > returns 400 for malformed request body
🔐 AUTH POST /api/auth/admin/login - 2025-10-22T18:28:23.237Z
🔑 Admin login attempt - handler entered
📋 Credentials received: { username: 'MISSING', hasPassword: false }

stderr | tests/integration/error-handling.test.ts > Error Handling > 400 Bad Request > returns 400 for malformed request body
❌ Missing credentials

stderr | tests/integration/error-handling.test.ts > Error Handling > 401 Unauthorized > returns 401 for protected routes without auth
❌ No admin token found in cookies

stdout | tests/integration/error-handling.test.ts > Error Handling > Content-Type validation > requires JSON content-type for POST requests
🔐 AUTH POST /api/auth/admin/login - 2025-10-22T18:28:23.252Z
🔑 Admin login attempt - handler entered

stderr | tests/integration/error-handling.test.ts > Error Handling > Content-Type validation > requires JSON content-type for POST requests
❌ Invalid request body

stdout | tests/integration/auth.routes.test.ts
[dotenv@17.2.3] injecting env (22) from .env -- tip: 🔐 prevent committing .env to code: https://dotenvx.com/precommit

stdout | tests/integration/auth.routes.test.ts > POST /api/auth/admin/login > rejects login with missing credentials
🔐 AUTH POST /api/auth/admin/login - 2025-10-22T18:28:24.056Z
🔑 Admin login attempt - handler entered
📋 Credentials received: { username: 'MISSING', hasPassword: false }

stderr | tests/integration/auth.routes.test.ts > POST /api/auth/admin/login > rejects login with missing credentials
❌ Missing credentials

stdout | tests/integration/cards.search.test.ts

✅ Test environment logs written:
   📄 C:\Git_Repos\mana_meeples_singles_market\apps\api\test-logs\test-env-1761157694560.txt
   📊 C:\Git_Repos\mana_meeples_singles_market\apps\api\test-logs\test-env-1761157694560.json

stdout | tests/integration/auth.routes.test.ts > POST /api/auth/admin/login > rejects login with invalid credentials
🔐 AUTH POST /api/auth/admin/login - 2025-10-22T18:28:24.073Z
🔑 Admin login attempt - handler entered
📋 Credentials received: { username: 'admin', hasPassword: true }
🔍 Validating credentials...
❌ Invalid credentials

stdout | tests/integration/error-handling.test.ts

✅ Test environment logs written:
   📄 C:\Git_Repos\mana_meeples_singles_market\apps\api\test-logs\test-env-1761157694573.txt
   📊 C:\Git_Repos\mana_meeples_singles_market\apps\api\test-logs\test-env-1761157694573.json

stderr | tests/integration/inventory.routes.test.ts > POST /api/admin/inventory > requires authentication
❌ No admin token found in cookies

stderr | tests/integration/orders.routes.test.ts > POST /api/orders > creates a new order with valid data
❌ Create order error: error: column "quality" of relation "order_items" does not exist
    at C:\Git_Repos\mana_meeples_singles_market\node_modules\.pnpm\pg@8.16.3\node_modules\pg\lib\client.js:545:17
    at processTicksAndRejections (node:internal/process/task_queues:95:5)
    at C:\Git_Repos\mana_meeples_singles_market\apps\api\src\routes\orders.ts:146:9 {
  length: 132,
  severity: 'ERROR',
  code: '42703',
  detail: undefined,
  hint: undefined,
  position: '132',
  internalPosition: undefined,
  internalQuery: undefined,
  where: undefined,
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'parse_target.c',
  line: '1066',
  routine: 'checkInsertTargets'
}

stdout | tests/integration/auth.routes.test.ts > POST /api/auth/admin/login > accepts valid admin credentials and sets cookie
🔐 AUTH POST /api/auth/admin/login - 2025-10-22T18:28:25.089Z
🔑 Admin login attempt - handler entered
📋 Credentials received: { username: 'admin', hasPassword: true }
🔍 Validating credentials...
✅ Credentials valid, generating token...
🎫 Token generated
🍪 Setting cookie with config: {
  httpOnly: true,
  secure: false,
  sameSite: 'strict',
  domain: '(current domain)'
}
📤 Sending response: { success: true, message: 'Login successful', expiresIn: '24h' }
✅ Response sent successfully

stdout | tests/integration/auth.routes.test.ts > POST /api/auth/admin/logout > clears the admin token cookie
🔐 AUTH POST /api/auth/admin/logout - 2025-10-22T18:28:25.095Z
🚪 Admin logout request

stdout | tests/integration/auth.routes.test.ts > GET /api/auth/admin/check > returns 401 when no token provided
🔐 AUTH GET /api/auth/admin/check - 2025-10-22T18:28:25.099Z
🔍 Admin auth check request
❌ No admin token found

stdout | tests/integration/auth.routes.test.ts > GET /api/auth/admin/check > returns authenticated status with valid token
🔐 AUTH POST /api/auth/admin/login - 2025-10-22T18:28:25.103Z
🔑 Admin login attempt - handler entered
📋 Credentials received: { username: 'admin', hasPassword: true }
🔍 Validating credentials...
✅ Credentials valid, generating token...
🎫 Token generated
🍪 Setting cookie with config: {
  httpOnly: true,
  secure: false,
  sameSite: 'strict',
  domain: '(current domain)'
}
📤 Sending response: { success: true, message: 'Login successful', expiresIn: '24h' }
✅ Response sent successfully

stdout | tests/integration/auth.routes.test.ts > GET /api/auth/admin/check > returns authenticated status with valid token
🔐 AUTH GET /api/auth/admin/check - 2025-10-22T18:28:25.110Z
🔍 Admin auth check request
🔍 Verifying token...
✅ Auth check successful for: admin

stderr | tests/e2e/checkout.flow.test.ts > Complete Checkout Flow (E2E) > handles out-of-stock scenario gracefully
❌ Create order error: Error: Insufficient stock for Lightning Bolt
    at C:\Git_Repos\mana_meeples_singles_market\apps\api\src\routes\orders.ts:142:17
    at processTicksAndRejections (node:internal/process/task_queues:95:5)

stdout | tests/integration/auth.routes.test.ts

✅ Test environment logs written:
   📄 C:\Git_Repos\mana_meeples_singles_market\apps\api\test-logs\test-env-1761157694574.txt
   📊 C:\Git_Repos\mana_meeples_singles_market\apps\api\test-logs\test-env-1761157694574.json

stderr | tests/e2e/checkout.flow.test.ts > Complete Checkout Flow (E2E) > handles concurrent orders for the same item
❌ Create order error: error: column "quality" of relation "order_items" does not exist
    at C:\Git_Repos\mana_meeples_singles_market\node_modules\.pnpm\pg@8.16.3\node_modules\pg\lib\client.js:545:17
    at processTicksAndRejections (node:internal/process/task_queues:95:5)
    at C:\Git_Repos\mana_meeples_singles_market\apps\api\src\routes\orders.ts:146:9 {
  length: 132,
  severity: 'ERROR',
  code: '42703',
  detail: undefined,
  hint: undefined,
  position: '132',
  internalPosition: undefined,
  internalQuery: undefined,
  where: undefined,
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'parse_target.c',
  line: '1066',
  routine: 'checkInsertTargets'
}

stderr | tests/e2e/checkout.flow.test.ts > Complete Checkout Flow (E2E) > handles concurrent orders for the same item
❌ Create order error: error: column "quality" of relation "order_items" does not exist
    at C:\Git_Repos\mana_meeples_singles_market\node_modules\.pnpm\pg@8.16.3\node_modules\pg\lib\client.js:545:17
    at processTicksAndRejections (node:internal/process/task_queues:95:5)
    at C:\Git_Repos\mana_meeples_singles_market\apps\api\src\routes\orders.ts:146:9 {
  length: 132,
  severity: 'ERROR',
  code: '42703',
  detail: undefined,
  hint: undefined,
  position: '132',
  internalPosition: undefined,
  internalQuery: undefined,
  where: undefined,
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'parse_target.c',
  line: '1066',
  routine: 'checkInsertTargets'
}

stderr | tests/e2e/checkout.flow.test.ts > Complete Checkout Flow (E2E) > allows admin to cancel an order and restore inventory
❌ Create order error: error: column "quality" of relation "order_items" does not exist
    at C:\Git_Repos\mana_meeples_singles_market\node_modules\.pnpm\pg@8.16.3\node_modules\pg\lib\client.js:545:17
    at processTicksAndRejections (node:internal/process/task_queues:95:5)
    at C:\Git_Repos\mana_meeples_singles_market\apps\api\src\routes\orders.ts:146:9 {
  length: 132,
  severity: 'ERROR',
  code: '42703',
  detail: undefined,
  hint: undefined,
  position: '132',
  internalPosition: undefined,
  internalQuery: undefined,
  where: undefined,
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'parse_target.c',
  line: '1066',
  routine: 'checkInsertTargets'
}

stderr | tests/integration/storefront.routes.test.ts
⚠️ Unexpected database pool error: terminating connection due to administrator command

stderr | tests/e2e/checkout.flow.test.ts > Complete Checkout Flow (E2E) > validates customer input sanitization during checkout
❌ Create order error: error: column "quality" of relation "order_items" does not exist
    at C:\Git_Repos\mana_meeples_singles_market\node_modules\.pnpm\pg@8.16.3\node_modules\pg\lib\client.js:545:17
    at processTicksAndRejections (node:internal/process/task_queues:95:5)
    at C:\Git_Repos\mana_meeples_singles_market\apps\api\src\routes\orders.ts:146:9 {
  length: 132,
  severity: 'ERROR',
  code: '42703',
  detail: undefined,
  hint: undefined,
  position: '132',
  internalPosition: undefined,
  internalQuery: undefined,
  where: undefined,
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'parse_target.c',
  line: '1066',
  routine: 'checkInsertTargets'
}

stdout | tests/integration/storefront.routes.test.ts

✅ Test environment logs written:
   📄 C:\Git_Repos\mana_meeples_singles_market\apps\api\test-logs\test-env-1761157694561.txt
   📊 C:\Git_Repos\mana_meeples_singles_market\apps\api\test-logs\test-env-1761157694561.json

stderr | tests/e2e/checkout.flow.test.ts > Complete Checkout Flow (E2E) > handles multiple items in a single order
❌ Create order error: error: column "quality" of relation "order_items" does not exist
    at C:\Git_Repos\mana_meeples_singles_market\node_modules\.pnpm\pg@8.16.3\node_modules\pg\lib\client.js:545:17
    at processTicksAndRejections (node:internal/process/task_queues:95:5)
    at C:\Git_Repos\mana_meeples_singles_market\apps\api\src\routes\orders.ts:146:9 {
  length: 132,
  severity: 'ERROR',
  code: '42703',
  detail: undefined,
  hint: undefined,
  position: '132',
  internalPosition: undefined,
  internalQuery: undefined,
  where: undefined,
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'parse_target.c',
  line: '1066',
  routine: 'checkInsertTargets'
}

stderr | tests/integration/orders.routes.test.ts > POST /api/orders > handles transaction rollback on inventory update failure
❌ Create order error: Error: Inventory item not found: 999999
    at C:\Git_Repos\mana_meeples_singles_market\apps\api\src\routes\orders.ts:135:17
    at processTicksAndRejections (node:internal/process/task_queues:95:5)

stderr | tests/e2e/checkout.flow.test.ts
⚠️ Unexpected database pool error: terminating connection due to administrator command
⚠️ Unexpected database pool error: terminating connection due to administrator command

stdout | tests/e2e/checkout.flow.test.ts

✅ Test environment logs written:
   📄 C:\Git_Repos\mana_meeples_singles_market\apps\api\test-logs\test-env-1761157694576.txt
   📊 C:\Git_Repos\mana_meeples_singles_market\apps\api\test-logs\test-env-1761157694576.json

stderr | tests/integration/inventory.routes.test.ts > GET /api/admin/inventory > requires authentication
❌ No admin token found in cookies

stderr | tests/integration/orders.routes.test.ts > GET /api/admin/orders > requires authentication
❌ No admin token found in cookies

stderr | tests/integration/inventory.routes.test.ts > PATCH /api/admin/inventory/:id > requires authentication
❌ No admin token found in cookies

stderr | tests/integration/orders.routes.test.ts > GET /api/admin/orders/:id > requires authentication
❌ No admin token found in cookies

stderr | tests/integration/orders.routes.test.ts > GET /api/admin/orders/:id > returns order details
❌ Database query error: column oi.quality does not exist
   Query: SELECT
        o.*,
        COALESCE(
          json_agg(
            json_build_object(
              'id', oi.id,
              'card_id', oi.card_id,
              'inventory_id', oi.inventory_id,
   Params: [1]
   Code: 42703
❌ Get admin order error: error: column oi.quality does not exist
    at C:\Git_Repos\mana_meeples_singles_market\node_modules\.pnpm\pg-pool@3.10.1_pg@8.16.3\node_modules\pg-pool\index.js:45:11
    at processTicksAndRejections (node:internal/process/task_queues:95:5)
    at Object.query (C:\Git_Repos\mana_meeples_singles_market\apps\api\src\lib\db.ts:68:22)
    at C:\Git_Repos\mana_meeples_singles_market\apps\api\src\routes\orders.ts:353:25 {
  length: 167,
  severity: 'ERROR',
  code: '42703',
  detail: undefined,
  hint: 'Perhaps you meant to reference the column "oi.quantity".',
  position: '268',
  internalPosition: undefined,
  internalQuery: undefined,
  where: undefined,
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'parse_relation.c',
  line: '3729',
  routine: 'errorMissingColumn'
}

stderr | tests/integration/inventory.routes.test.ts > DELETE /api/admin/inventory/:id > requires authentication
❌ No admin token found in cookies

stderr | tests/integration/orders.routes.test.ts > GET /api/admin/orders/:id > returns 404 for non-existent order
❌ Database query error: column oi.quality does not exist
   Query: SELECT
        o.*,
        COALESCE(
          json_agg(
            json_build_object(
              'id', oi.id,
              'card_id', oi.card_id,
              'inventory_id', oi.inventory_id,
   Params: [999999]
   Code: 42703
❌ Get admin order error: error: column oi.quality does not exist
    at C:\Git_Repos\mana_meeples_singles_market\node_modules\.pnpm\pg-pool@3.10.1_pg@8.16.3\node_modules\pg-pool\index.js:45:11
    at processTicksAndRejections (node:internal/process/task_queues:95:5)
    at Object.query (C:\Git_Repos\mana_meeples_singles_market\apps\api\src\lib\db.ts:68:22)
    at C:\Git_Repos\mana_meeples_singles_market\apps\api\src\routes\orders.ts:353:25 {
  length: 167,
  severity: 'ERROR',
  code: '42703',
  detail: undefined,
  hint: 'Perhaps you meant to reference the column "oi.quantity".',
  position: '268',
  internalPosition: undefined,
  internalQuery: undefined,
  where: undefined,
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'parse_relation.c',
  line: '3729',
  routine: 'errorMissingColumn'
}

stderr | tests/integration/orders.routes.test.ts > PATCH /api/admin/orders/:id/status > requires authentication
❌ No admin token found in cookies

stderr | tests/integration/inventory.routes.test.ts
⚠️ Unexpected database pool error: terminating connection due to administrator command

stdout | tests/integration/inventory.routes.test.ts

✅ Test environment logs written:
   📄 C:\Git_Repos\mana_meeples_singles_market\apps\api\test-logs\test-env-1761157694576.txt
   📊 C:\Git_Repos\mana_meeples_singles_market\apps\api\test-logs\test-env-1761157694576.json

stderr | tests/integration/orders.routes.test.ts
⚠️ Unexpected database pool error: terminating connection due to administrator command

stdout | tests/integration/orders.routes.test.ts

✅ Test environment logs written:
   📄 C:\Git_Repos\mana_meeples_singles_market\apps\api\test-logs\test-env-1761157694560.txt
   📊 C:\Git_Repos\mana_meeples_singles_market\apps\api\test-logs\test-env-1761157694560.json

 ❯ tests/e2e/checkout.flow.test.ts (6) 17142ms
   ❯ Complete Checkout Flow (E2E) (6) 8160ms
     × completes a full customer journey from browsing to order placement 1619ms
     × handles out-of-stock scenario gracefully 1408ms
     × handles concurrent orders for the same item 1355ms
     × allows admin to cancel an order and restore inventory 1358ms
     × validates customer input sanitization during checkout 1273ms
     × handles multiple items in a single order 1144ms
 ✓ tests/integration/auth.routes.test.ts (6) 11408ms
 ✓ tests/integration/cards.search.test.ts (1) 9491ms
 ✓ tests/integration/error-handling.test.ts (7) 9676ms
 ❯ tests/integration/inventory.routes.test.ts (16) 26009ms
   ❯ POST /api/admin/inventory (6) 8029ms
     ✓ requires authentication 1537ms
     ✓ creates new inventory with valid data 1379ms
     × updates existing inventory on conflict 1343ms
     ✓ rejects invalid card_id 1387ms
     ✓ rejects negative stock quantity 1268ms
     ✓ rejects missing required fields 1113ms
   ✓ GET /api/admin/inventory (3) 2947ms
   ✓ PATCH /api/admin/inventory/:id (4) 3522ms
   ✓ DELETE /api/admin/inventory/:id (3) 2646ms
 ❯ tests/integration/orders.routes.test.ts (19) 27751ms
   ❯ POST /api/orders (6) 7999ms
     × creates a new order with valid data 1516ms
     × validates required customer fields 1337ms
     ✓ validates items array is not empty 1365ms
     ✓ validates item quantity limits 1355ms
     ✓ validates email format 1276ms
     × handles transaction rollback on inventory update failure 1149ms
   ✓ GET /api/admin/orders (5) 4694ms
   ❯ GET /api/admin/orders/:id (3) 2678ms
     ✓ requires authentication 892ms
     × returns order details 876ms
     × returns 404 for non-existent order 909ms
   ✓ PATCH /api/admin/orders/:id/status (5) 3354ms
 ✓ tests/integration/storefront.routes.test.ts (5) 15488ms
 ✓ tests/unit/auth.validateCredentials.test.ts (4)
 ✓ tests/unit/slugify.test.ts (1)
 ✓ tests/unit/utils.test.ts (43)
 ✓ tests/unit/validation.test.ts (10)

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯ Failed Tests 12 ⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯

 FAIL  tests/e2e/checkout.flow.test.ts > Complete Checkout Flow (E2E) > completes a full customer journey from browsing to order placement
Error: expected 200 "OK", got 404 "Not Found"
 ❯ tests/e2e/checkout.flow.test.ts:49:8
     47|     const cardDetailsRes = await request(app)
     48|       .get(`/api/storefront/cards/${selectedCard.id}`)
     49|       .expect(200);
       |        ^
     50|
     51|     expect(cardDetailsRes.body.card).toBeDefined();
 ❯ Test._assertStatus ../../node_modules/.pnpm/supertest@7.1.4/node_modules/supertest/lib/test.js:309:14
 ❯ ../../node_modules/.pnpm/supertest@7.1.4/node_modules/supertest/lib/test.js:365:13
 ❯ Test._assertFunction ../../node_modules/.pnpm/supertest@7.1.4/node_modules/supertest/lib/test.js:342:13
 ❯ Test.assert ../../node_modules/.pnpm/supertest@7.1.4/node_modules/supertest/lib/test.js:195:23
 ❯ localAssert ../../node_modules/.pnpm/supertest@7.1.4/node_modules/supertest/lib/test.js:138:14
 ❯ Server.<anonymous> ../../node_modules/.pnpm/supertest@7.1.4/node_modules/supertest/lib/test.js:152:11

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[1/12]⎯

 FAIL  tests/e2e/checkout.flow.test.ts > Complete Checkout Flow (E2E) > handles out-of-stock scenario gracefully
Error: expected 400 "Bad Request", got 500 "Internal Server Error"
 ❯ tests/e2e/checkout.flow.test.ts:191:8
    189|       .post("/api/orders")
    190|       .send(orderData)
    191|       .expect(400);
       |        ^
    192|
    193|     expect(orderRes.body).toHaveProperty("error");
 ❯ Test._assertStatus ../../node_modules/.pnpm/supertest@7.1.4/node_modules/supertest/lib/test.js:309:14
 ❯ ../../node_modules/.pnpm/supertest@7.1.4/node_modules/supertest/lib/test.js:365:13
 ❯ Test._assertFunction ../../node_modules/.pnpm/supertest@7.1.4/node_modules/supertest/lib/test.js:342:13
 ❯ Test.assert ../../node_modules/.pnpm/supertest@7.1.4/node_modules/supertest/lib/test.js:195:23
 ❯ localAssert ../../node_modules/.pnpm/supertest@7.1.4/node_modules/supertest/lib/test.js:138:14
 ❯ Server.<anonymous> ../../node_modules/.pnpm/supertest@7.1.4/node_modules/supertest/lib/test.js:152:11

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[2/12]⎯

 FAIL  tests/e2e/checkout.flow.test.ts > Complete Checkout Flow (E2E) > handles concurrent orders for the same item
AssertionError: expected +0 to be 1 // Object.is equality

- Expected
+ Received

- 1
+ 0

 ❯ tests/e2e/checkout.flow.test.ts:246:30
    244|     const failed = results.filter(r => r.status === 400);
    245|
    246|     expect(succeeded.length).toBe(1);
       |                              ^
    247|     expect(failed.length).toBe(1);
    248|     expect(failed[0].body.error).toMatch(/stock|inventory/i);

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[3/12]⎯

 FAIL  tests/e2e/checkout.flow.test.ts > Complete Checkout Flow (E2E) > allows admin to cancel an order and restore inventory
Error: expected 201 "Created", got 500 "Internal Server Error"
 ❯ tests/e2e/checkout.flow.test.ts:282:8
    280|       .post("/api/orders")
    281|       .send(orderData)
    282|       .expect(201);
       |        ^
    283|
    284|     const orderId = orderRes.body.order.id;
 ❯ Test._assertStatus ../../node_modules/.pnpm/supertest@7.1.4/node_modules/supertest/lib/test.js:309:14
 ❯ ../../node_modules/.pnpm/supertest@7.1.4/node_modules/supertest/lib/test.js:365:13
 ❯ Test._assertFunction ../../node_modules/.pnpm/supertest@7.1.4/node_modules/supertest/lib/test.js:342:13
 ❯ Test.assert ../../node_modules/.pnpm/supertest@7.1.4/node_modules/supertest/lib/test.js:195:23
 ❯ localAssert ../../node_modules/.pnpm/supertest@7.1.4/node_modules/supertest/lib/test.js:138:14
 ❯ Server.<anonymous> ../../node_modules/.pnpm/supertest@7.1.4/node_modules/supertest/lib/test.js:152:11

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[4/12]⎯

 FAIL  tests/e2e/checkout.flow.test.ts > Complete Checkout Flow (E2E) > validates customer input sanitization during checkout
Error: expected 201 "Created", got 500 "Internal Server Error"
 ❯ tests/e2e/checkout.flow.test.ts:356:8
    354|       .post("/api/orders")
    355|       .send(maliciousOrderData)
    356|       .expect(201);
       |        ^
    357|
    358|     // Verify malicious content was sanitized
 ❯ Test._assertStatus ../../node_modules/.pnpm/supertest@7.1.4/node_modules/supertest/lib/test.js:309:14
 ❯ ../../node_modules/.pnpm/supertest@7.1.4/node_modules/supertest/lib/test.js:365:13
 ❯ Test._assertFunction ../../node_modules/.pnpm/supertest@7.1.4/node_modules/supertest/lib/test.js:342:13
 ❯ Test.assert ../../node_modules/.pnpm/supertest@7.1.4/node_modules/supertest/lib/test.js:195:23
 ❯ localAssert ../../node_modules/.pnpm/supertest@7.1.4/node_modules/supertest/lib/test.js:138:14
 ❯ Server.<anonymous> ../../node_modules/.pnpm/supertest@7.1.4/node_modules/supertest/lib/test.js:152:11

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[5/12]⎯

 FAIL  tests/e2e/checkout.flow.test.ts > Complete Checkout Flow (E2E) > handles multiple items in a single order
Error: expected 201 "Created", got 500 "Internal Server Error"
 ❯ tests/e2e/checkout.flow.test.ts:412:8
    410|       .post("/api/orders")
    411|       .send(orderData)
    412|       .expect(201);
       |        ^
    413|
    414|     expect(orderRes.body.order).toBeDefined();
 ❯ Test._assertStatus ../../node_modules/.pnpm/supertest@7.1.4/node_modules/supertest/lib/test.js:309:14
 ❯ ../../node_modules/.pnpm/supertest@7.1.4/node_modules/supertest/lib/test.js:365:13
 ❯ Test._assertFunction ../../node_modules/.pnpm/supertest@7.1.4/node_modules/supertest/lib/test.js:342:13
 ❯ Test.assert ../../node_modules/.pnpm/supertest@7.1.4/node_modules/supertest/lib/test.js:195:23
 ❯ localAssert ../../node_modules/.pnpm/supertest@7.1.4/node_modules/supertest/lib/test.js:138:14
 ❯ Server.<anonymous> ../../node_modules/.pnpm/supertest@7.1.4/node_modules/supertest/lib/test.js:152:11

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[6/12]⎯

 FAIL  tests/integration/inventory.routes.test.ts > POST /api/admin/inventory > updates existing inventory on conflict
AssertionError: expected '7.99' to be 7.99 // Object.is equality

- Expected:
7.99

+ Received:
"7.99"

 ❯ tests/integration/inventory.routes.test.ts:104:38
    102|       .expect(200);
    103|
    104|     expect(res.body.inventory.price).toBe(7.99);
       |                                      ^
    105|     expect(res.body.inventory.stock_quantity).toBe(20);
    106|   });

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[7/12]⎯

 FAIL  tests/integration/orders.routes.test.ts > POST /api/orders > creates a new order with valid data
Error: expected 201 "Created", got 500 "Internal Server Error"
 ❯ tests/integration/orders.routes.test.ts:69:8
     67|       .post("/api/orders")
     68|       .send(orderData)
     69|       .expect(201);
       |        ^
     70|
     71|     expect(res.body).toHaveProperty("order");
 ❯ Test._assertStatus ../../node_modules/.pnpm/supertest@7.1.4/node_modules/supertest/lib/test.js:309:14
 ❯ ../../node_modules/.pnpm/supertest@7.1.4/node_modules/supertest/lib/test.js:365:13
 ❯ Test._assertFunction ../../node_modules/.pnpm/supertest@7.1.4/node_modules/supertest/lib/test.js:342:13
 ❯ Test.assert ../../node_modules/.pnpm/supertest@7.1.4/node_modules/supertest/lib/test.js:195:23
 ❯ localAssert ../../node_modules/.pnpm/supertest@7.1.4/node_modules/supertest/lib/test.js:138:14
 ❯ Server.<anonymous> ../../node_modules/.pnpm/supertest@7.1.4/node_modules/supertest/lib/test.js:152:11

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[8/12]⎯

 FAIL  tests/integration/orders.routes.test.ts > POST /api/orders > validates required customer fields
AssertionError: expected 'customer: Required' to contain 'email'

Expected: "email"
Received: "customer: Required"

 ❯ tests/integration/orders.routes.test.ts:101:28
     99|
    100|     expect(res.body).toHaveProperty("error");
    101|     expect(res.body.error).toContain("email");
       |                            ^
    102|   });
    103|

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[9/12]⎯

 FAIL  tests/integration/orders.routes.test.ts > POST /api/orders > handles transaction rollback on inventory update failure
Error: expected 400 "Bad Request", got 500 "Internal Server Error"
 ❯ tests/integration/orders.routes.test.ts:195:8
    193|       .post("/api/orders")
    194|       .send(orderData)
    195|       .expect(400);
       |        ^
    196|
    197|     expect(res.body).toHaveProperty("error");
 ❯ Test._assertStatus ../../node_modules/.pnpm/supertest@7.1.4/node_modules/supertest/lib/test.js:309:14
 ❯ ../../node_modules/.pnpm/supertest@7.1.4/node_modules/supertest/lib/test.js:365:13
 ❯ Test._assertFunction ../../node_modules/.pnpm/supertest@7.1.4/node_modules/supertest/lib/test.js:342:13
 ❯ Test.assert ../../node_modules/.pnpm/supertest@7.1.4/node_modules/supertest/lib/test.js:195:23
 ❯ localAssert ../../node_modules/.pnpm/supertest@7.1.4/node_modules/supertest/lib/test.js:138:14
 ❯ Server.<anonymous> ../../node_modules/.pnpm/supertest@7.1.4/node_modules/supertest/lib/test.js:152:11

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[10/12]⎯

 FAIL  tests/integration/orders.routes.test.ts > GET /api/admin/orders/:id > returns order details
Error: expected 200 "OK", got 500 "Internal Server Error"
 ❯ tests/integration/orders.routes.test.ts:279:8
    277|       .get(`/api/admin/orders/${orderId}`)
    278|       .set("Cookie", authToken)
    279|       .expect(200);
       |        ^
    280|
    281|     expect(res.body).toHaveProperty("order");
 ❯ Test._assertStatus ../../node_modules/.pnpm/supertest@7.1.4/node_modules/supertest/lib/test.js:309:14
 ❯ ../../node_modules/.pnpm/supertest@7.1.4/node_modules/supertest/lib/test.js:365:13
 ❯ Test._assertFunction ../../node_modules/.pnpm/supertest@7.1.4/node_modules/supertest/lib/test.js:342:13
 ❯ Test.assert ../../node_modules/.pnpm/supertest@7.1.4/node_modules/supertest/lib/test.js:195:23
 ❯ localAssert ../../node_modules/.pnpm/supertest@7.1.4/node_modules/supertest/lib/test.js:138:14
 ❯ Server.<anonymous> ../../node_modules/.pnpm/supertest@7.1.4/node_modules/supertest/lib/test.js:152:11

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[11/12]⎯

 FAIL  tests/integration/orders.routes.test.ts > GET /api/admin/orders/:id > returns 404 for non-existent order
Error: expected 404 "Not Found", got 500 "Internal Server Error"
 ❯ tests/integration/orders.routes.test.ts:290:8
    288|       .get("/api/admin/orders/999999")
    289|       .set("Cookie", authToken)
    290|       .expect(404);
       |        ^
    291|
    292|     expect(res.body).toHaveProperty("error");
 ❯ Test._assertStatus ../../node_modules/.pnpm/supertest@7.1.4/node_modules/supertest/lib/test.js:309:14
 ❯ ../../node_modules/.pnpm/supertest@7.1.4/node_modules/supertest/lib/test.js:365:13
 ❯ Test._assertFunction ../../node_modules/.pnpm/supertest@7.1.4/node_modules/supertest/lib/test.js:342:13
 ❯ Test.assert ../../node_modules/.pnpm/supertest@7.1.4/node_modules/supertest/lib/test.js:195:23
 ❯ localAssert ../../node_modules/.pnpm/supertest@7.1.4/node_modules/supertest/lib/test.js:138:14
 ❯ Server.<anonymous> ../../node_modules/.pnpm/supertest@7.1.4/node_modules/supertest/lib/test.js:152:11

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[12/12]⎯

 Test Files  3 failed | 8 passed (11)
      Tests  12 failed | 106 passed (118)
   Start at  07:28:13
   Duration  28.94s (transform 762ms, setup 0ms, collect 6.33s, tests 117.11s, environment 2ms, prepare 1.48s)

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit