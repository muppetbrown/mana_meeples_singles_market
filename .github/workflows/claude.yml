name: Claude Code

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, assigned]
  pull_request_review:
    types: [submitted]

jobs:
  claude:
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude')) ||
      (github.event_name == 'issues' && (contains(github.event.issue.body, '@claude') || contains(github.event.issue.title, '@claude')))
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      actions: read # Required for Claude to read CI results on PRs
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Run Claude Code
        id: claude
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          claude_args: |
            --model claude-sonnet-4-20250514
            --allowedTools "Bash(pnpm install),Bash(pnpm install *),Bash(pnpm run *),Bash(pnpm build),Bash(pnpm test),Bash(pnpm test:*),Bash(git status),Bash(git log),Bash(git diff),Bash(git show *),Bash(node *),Bash(cat *),Bash(ls *),Bash(pwd),Bash(which *)"
            --system-prompt "Follow the AI Software Development Principles documented in the repository. Always search for existing implementations before creating new code. Ensure all code follows existing patterns and conventions. Use TypeScript for new files. Maintain consistency with the project structure."
